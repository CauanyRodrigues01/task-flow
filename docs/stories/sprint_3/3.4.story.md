# História 3.4: "Snapshot de Contexto" na Mudança de Status (Kanban)

## Status
Pronto para Revisão

## História
**Como um** Colaborador,
**Eu quero** fornecer rapidamente um contexto adicional ao mudar o status de uma tarefa no quadro Kanban,
**para que** o histórico de atividades seja sempre rico e transparente, sem exigir esforço excessivo.

## Critérios de Aceitação
1. Ao arrastar e soltar um cartão de tarefa entre as colunas de status no quadro Kanban, o sistema deve apresentar um prompt para o Colaborador adicionar uma "Nota Rápida" ou selecionar um item de uma "Lista de Verificação Breve" pré-definida (se aplicável).
2. A "Nota Rápida" deve ser um campo de texto livre e opcional, mas encorajado.
3. A "Lista de Verificação Breve" (se implementada) deve ser uma lista de itens pré-definidos que o Colaborador pode marcar rapidamente.
4. O conteúdo da "Nota Rápida" ou da "Lista de Verificação Breve" deve ser registrado como parte do evento de mudança de status no histórico de atividades da tarefa.
5. Esta funcionalidade deve ser projetada para ter baixo atrito, não interrompendo significativamente o fluxo de trabalho do Colaborador.
6. O comportamento da API/lógica de backend para esta funcionalidade pode ser verificado localmente (ex: via chamada direta à API, CLI ou teste de unidade/integração).

## Notas do Desenvolvedor

### Especificações da API
- O endpoint de atualização de status da tarefa precisa ser modificado para aceitar um campo de contexto opcional.
- **Endpoint:** `PATCH /projects/{projectId}/tasks/{taskId}`
- **Corpo da Requisição (Modificado):**
  ```json
  {
    "status": "IN_PROGRESS",
    "context_note": "Iniciei a implementação da API."
  }
  ```
- O campo `context_note` é opcional. Se fornecido, seu conteúdo será anexado à descrição do evento no `ActivityHistory`.
- [Fonte: architecture/8-especificao-da_api-restful.md (Modificação)]

### Arquitetura do Backend
- A principal mudança será no `TaskService`. O método que atualiza o status da tarefa (`updateTaskStatus` ou similar) deve ser modificado para aceitar a `context_note`.
- O `ActivityHistoryService` será chamado com uma descrição mais rica, que inclui a nota de contexto. Por exemplo: "Usuário 'X' alterou o status para 'Em Progresso'. Nota: Iniciei a implementação da API."
- [Fonte: architecture/6-arquitetura-do-backend-monlito-modular.md]

### Arquitetura do Frontend
- A lógica para exibir um modal ou um prompt para a "Nota Rápida" quando uma tarefa é movida no Kanban será implementada no frontend.
- O componente do Kanban (em `taskflow-frontend/src/features/tasks/`) precisará gerenciar o estado para exibir este prompt e, em seguida, incluir a `context_note` na chamada da API para o backend.
- [Fonte: architecture/7-arquitetura-do-frontend-spa.md (Não lido, mas inferido)]

### Localização dos Arquivos (Backend)
- `taskflow-backend/src/main/java/com.taskflow/task/TaskService.java` (modificação para aceitar `context_note`)
- `taskflow-backend/src/main/java/com.taskflow/task/dto/TaskUpdateRequestDto.java` (adicionar campo `context_note`)
- `taskflow-backend/src/main/java/com.taskflow/activityhistory/ActivityHistoryService.java` (modificação para formatar a descrição com a nota)
- [Fonte: architecture/4-estrutura-unificada-do-projeto-polyrepo.md]

## Tarefas / Subtarefas
- [x] **Backend: DTO** (CA: 1, 2, 4)
  - [x] Adicionar um campo opcional `String contextNote` ao DTO `TaskRequestDto.java` (modificado `TaskRequestDto` conforme análise).
- [x] **Backend: Serviço** (CA: 4)
  - [x] Modificar o método de atualização de tarefa em `TaskService.java` para aceitar o `contextNote`.
  - [x] Ao registrar a mudança de status no `ActivityHistoryService`, formatar a descrição para incluir a `contextNote` se ela estiver presente.
- [x] **Backend: Testes** (CA: 6)
  - [x] Atualizar os testes de integração para o endpoint de atualização de tarefa para incluir casos de teste com e sem a `contextNote`.
  - [x] Verificar se o `ActivityHistory` é gravado corretamente com o contexto adicional.
- [ ] **Frontend: UI (Alto Nível)** (CA: 1, 2, 5)
  - [ ] (Nota para o dev Frontend) Implementar um modal/prompt que aparece ao mover um card no Kanban.
  - [ ] (Nota para o dev Frontend) O modal deve conter um campo de texto para a "Nota Rápida".
  - [ ] (Nota para o dev Frontend) Ao submeter, a nota deve ser enviada para a API no campo `context_note`.

## Testes
- **Testes de Integração (Backend):** Focar em validar que o endpoint `PATCH /tasks/{taskId}` processa corretamente o campo `context_note` e que o histórico de atividades reflete essa informação.
- [Fonte: architecture/11-estratgia-de-testes.md]

## Dev Agent Record
### Agent Model Used
Gemini

### Debug Log References
- `TaskRequestDto.java` modified to include `contextNote`.
- `TaskService.java` modified to utilize `contextNote` in `updateTaskStatus` for activity history.
- `TaskControllerIntegrationTest.java` created with tests for `updateTaskStatus` including `contextNote` verification.

### Completion Notes List
- Implementação completa do backend para a funcionalidade de "Snapshot de Contexto" na mudança de status (Kanban), incluindo modificação de DTO, atualização do serviço e criação de testes de integração.
- O campo `contextNote` opcional é agora aceito na atualização de status e registrado no histórico de atividades.
- O frontend precisará implementar a interface de usuário para capturar o `contextNote` e enviá-lo para a API.

### File List
- `taskflow-backend/src/main/java/com.taskflow/task/dto/TaskRequestDto.java` (modificado)
- `taskflow-backend/src/main/java/com.taskflow/task/TaskService.java` (modificado)
- `taskflow-backend/src/test/java/com.taskflow/task/TaskControllerIntegrationTest.java` (criado e modificado)

## Log de Alterações
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-11-06 | 1.0 | Rascunho inicial | sm |
| 2025-11-07 | 1.1 | Implementação do backend para "Snapshot de Contexto" em mudanças de status | James |
