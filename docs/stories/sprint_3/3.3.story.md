# História 3.3: Histórico de Atividades "Context-Aware"

## Status
Pronto para Desenvolvimento

## História
**Como um** usuário (Gerente de Projeto ou Colaborador),
**Eu quero** ver um histórico detalhado e contextualizado de todas as alterações em uma tarefa,
**para que** eu possa entender o "porquê" por trás de cada mudança e ter total transparência sobre o progresso.

## Critérios de Aceitação
1. Cada tarefa deve ter um histórico de atividades que registra automaticamente: criação da tarefa, atribuição/reatribuição de responsável, mudanças de status, edições de campos (título, descrição, prioridade, data de vencimento) e adições de comentários.
2. Para cada evento no histórico, o sistema deve registrar: o usuário que realizou a ação, a data/hora da ação e uma descrição clara da mudança.
3. Para mudanças de status, o backend deve registrar a causa contextual da mudança (ex: "Tarefa movida para 'Em Andamento' por [Usuário] via Kanban").
4. O histórico de atividades deve ser imutável e visível para todos os membros do projeto associados à tarefa.
5. O comportamento da API/lógica de backend para esta funcionalidade pode ser verificado localmente (ex: via chamada direta à API, CLI ou teste de unidade/integração).

## Notas do Desenvolvedor

### Modelos de Dados
- Uma nova entidade `ActivityHistory` e a tabela `activity_history` correspondente são necessárias.
- **Schema:**
  ```sql
  CREATE TABLE activity_history (
      id BIGINT AUTO_INCREMENT PRIMARY KEY,
      task_id BIGINT NOT NULL,
      user_id BIGINT,
      description TEXT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
      FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE SET NULL
  );
  ```
- [Fonte: architecture/5-modelagem-de-dados.md (Adaptado para nova entidade)]

### Especificações da API
- **Endpoint para listar histórico:** `GET /tasks/{taskId}/history`
  - **Permissão:** O usuário autenticado deve ser um membro do projeto ao qual a tarefa pertence.
  - **Resposta:** Lista de eventos de histórico da tarefa.
- [Fonte: architecture/8-especificao-da-api-restful.md (Adaptado para nova funcionalidade)]

### Arquitetura do Backend
- Seguir o padrão "package-by-feature", criando um novo pacote `com.taskflow.activityhistory`.
- Este pacote conterá `ActivityHistory.java` (Entidade), `ActivityHistoryRepository.java` (Spring Data JPA) e `ActivityHistoryService.java` (lógica de negócio).
- A lógica de registro de histórico será integrada aos serviços existentes (`TaskService`, `CommentService`) para registrar eventos quando as ações dos CAs ocorrerem.
- [Fonte: architecture/6-arquitetura-do-backend-monlito-modular.md]

### Localização dos Arquivos (Backend)
- `taskflow-backend/src/main/java/com/taskflow/activityhistory/ActivityHistory.java`
- `taskflow-backend/src/main/java/com/taskflow/activityhistory/ActivityHistoryRepository.java`
- `taskflow-backend/src/main/java/com/taskflow/activityhistory/ActivityHistoryService.java`
- `taskflow-backend/src/main/java/com/taskflow/activityhistory/ActivityHistoryController.java`
- `taskflow-backend/src/main/java/com/taskflow/activityhistory/dto/ActivityHistoryResponseDto.java`
- `taskflow-backend/src/main/java/com/taskflow/task/TaskService.java` (modificação para registrar todas as alterações de tarefa)
- `taskflow-backend/src/main/java/com/taskflow/comment/CommentService.java` (modificação para registrar adição de comentário)
- [Fonte: architecture/4-estrutura-unificada-do-projeto-polyrepo.md]

## Tarefas / Subtarefas
- [x] **Backend: Modelo** (CA: 1, 2)
  - [x] Criar a entidade JPA `ActivityHistory.java` no pacote `com.taskflow.activityhistory`.
  - [x] Criar a interface `ActivityHistoryRepository.java`.
  - [x] Criar o DTO `ActivityHistoryResponseDto`.
- [x] **Backend: Serviço** (CA: 1, 2, 3)
  - [x] Criar a classe `ActivityHistoryService.java` com um método `recordActivity(Long taskId, Long userId, String description)`.
  - [x] Modificar `TaskService.java` para chamar `ActivityHistoryService` em todos os métodos que alteram dados da tarefa (criar, editar, atribuir, mudar status).
    - [x] As descarefas devem ser claras (ex: "Usuário 'X' alterou o status de 'A Fazer' para 'Em Progresso'").
    - [x] Para mudanças de status, incluir o contexto (CA: 3).
  - [x] Modificar `CommentService.java` para chamar `ActivityHistoryService` quando um novo comentário é adicionado.
- [x] **Backend: Controlador** (CA: 4)
  - [x] Criar `ActivityHistoryController.java` com o endpoint `GET /tasks/{taskId}/history`.
  - [x] Implementar a lógica para buscar e retornar o histórico de uma tarefa.
  - [x] Proteger o endpoint com `@PreAuthorize`.
- [x] **Backend: Testes** (CA: 5)
  - [x] Escrever testes unitários para `ActivityHistoryService`.
  - [x] Escrever testes de integração para `ActivityHistoryController`.
  - [x] Atualizar testes de `TaskService` e `CommentService` para verificar se o registro de histórico está sendo chamado.

## Testes
- **Testes Unitários (Backend):** Utilizar JUnit 5 e Mockito para testar a lógica na camada de `Service`.
- **Testes de Integração (Backend):** Utilizar `@SpringBootTest` para testar o fluxo completo da API.
- [Fonte: architecture/11-estratgia-de-testes.md]

## Log de Alterações
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-11-06 | 1.0 | Rascunho inicial | sm |