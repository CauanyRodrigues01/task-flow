# História 3.1: Comentários em Tarefas

## Status
Pronto para Desenvolvimento

## História
**Como um** usuário (Gerente de Projeto ou Colaborador),
**Eu quero** adicionar comentários às tarefas,
**para que** eu possa me comunicar sobre o trabalho e fornecer informações adicionais.

## Critérios de Aceitação
1. Os usuários devem ser capazes de adicionar comentários de texto a qualquer tarefa.
2. Cada comentário deve exibir o autor e a data/hora da postagem.
3. Os comentários devem ser visíveis para todos os membros do projeto associados à tarefa.
4. O sistema deve registrar a adição de um comentário no histórico de atividades da tarefa.
5. O comportamento da API/lógica de backend para esta funcionalidade pode ser verificado localmente (ex: via chamada direta à API, CLI ou teste de unidade/integração).

## Notas do Desenvolvedor

### Modelos de Dados
- Uma nova entidade `Comment` e a tabela `comments` correspondente são necessárias.
- **Schema:**
  ```sql
  CREATE TABLE comments (
      id BIGINT AUTO_INCREMENT PRIMARY KEY,
      content TEXT NOT NULL,
      task_id BIGINT NOT NULL,
      author_id BIGINT NOT NULL,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
      FOREIGN KEY (author_id) REFERENCES users(id) ON DELETE CASCADE
  );
  ```
- [Fonte: architecture/5-modelagem-de-dados.md]

### Especificações da API
- **Endpoint:** `POST /tasks/{taskId}/comments`
- **Permissão:** Requer que o usuário autenticado seja um membro do projeto ao qual a tarefa pertence (`ADMIN`, `PROJECT_MANAGER`, `COLLABORATOR`).
- **Corpo da Requisição:** Um JSON com o campo `content` (ex: `{ "content": "Este é um novo comentário." }`).
- O `author_id` será extraído do token JWT do usuário autenticado.
- [Fonte: architecture/8-especificao-da-api-restful.md]

### Arquitetura do Backend
- Seguir o padrão "package-by-feature", criando um novo pacote `com.taskflow.comment`.
- Este pacote conterá `Comment.java` (Entidade), `CommentRepository.java` (Spring Data JPA), `CommentService.java` (lógica de negócio) e `CommentController.java`.
- [Fonte: architecture/6-arquitetura-do-backend-monlito-modular.md]

### Localização dos Arquivos (Backend)
- `taskflow-backend/src/main/java/com/taskflow/comment/Comment.java`
- `taskflow-backend/src/main/java/com/taskflow/comment/CommentRepository.java`
- `taskflow-backend/src/main/java/com/taskflow/comment/CommentService.java`
- `taskflow-backend/src/main/java/com/taskflow/comment/CommentController.java`
- `taskflow-backend/src/main/java/com/taskflow/comment/dto/CommentRequestDto.java`
- `taskflow-backend/src/main/java/com/taskflow/comment/dto/CommentResponseDto.java`
- [Fonte: architecture/4-estrutura-unificada-do-projeto-polyrepo.md]

## Tarefas / Subtarefas
- [x] **Backend: Modelo** (CA: 1, 2)
  - [x] Criar a entidade JPA `Comment.java` no pacote `com.taskflow.comment` mapeando a tabela `comments`.
  - [x] Criar a interface `CommentRepository.java` que estende `JpaRepository<Comment, Long>`.
  - [x] Criar os DTOs `CommentRequestDto` e `CommentResponseDto`.
- [x] **Backend: Serviço** (CA: 1, 3, 4)
  - [x] Criar a classe `CommentService.java`.
  - [x] Implementar o método `createComment(Long taskId, CommentRequestDto commentDto, User author)` que:
    - [x] Valida a existência da tarefa (`Task`).
    - [x] Verifica se o `author` tem permissão para comentar na tarefa (é membro do projeto).
    - [x] Salva o novo comentário no banco de dados.
    - [x] (Nota: O registro no histórico de atividades será totalmente implementado na história 3.3).
- [x] **Backend: Controlador** (CA: 1, 3)
  - [x] Criar `CommentController.java` com o endpoint `POST /tasks/{taskId}/comments`.
  - [x] Implementar a lógica do endpoint para receber a requisição, chamar o `CommentService` e retornar a resposta.
  - [x] Proteger o endpoint com `@PreAuthorize` para garantir que apenas membros do projeto possam acessá-lo.
- [x] **Backend: Testes** (CA: 5)
  - [x] Escrever testes unitários para `CommentService` usando JUnit 5 e Mockito.
  - [x] Escrever testes de integração para o `CommentController` usando `@SpringBootTest` e um banco de dados em memória (H2).

## Dev Agent Record
**Completion Notes:**
- A implementação do backend para a funcionalidade de comentários foi concluída.
- Os testes unitários e de integração foram escritos, mas os testes de integração estão falhando devido a problemas com a configuração do ambiente de teste. O banco de dados em memória não está sendo criado corretamente, o que causa falhas nos testes. Mais depuração é necessária para resolver os problemas de configuração do teste.


## Testes
- **Testes Unitários (Backend):** Utilizar JUnit 5 e Mockito para testar a lógica na camada de `Service`, mockando o repositório.
- **Testes de Integração (Backend):** Utilizar `@SpringBootTest` para testar o fluxo completo da API, do `Controller` ao banco de dados em memória.
- [Fonte: architecture/11-estratgia-de-testes.md]

## Log de Alterações
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-11-06 | 1.0 | Rascunho inicial | sm |