# História 3.2: Notificações Básicas de Atividade

## Status
Pronto para Revisão

## História
**Como um** usuário,
**Eu quero** receber notificações sobre atividades relevantes em minhas tarefas e projetos,
**para que** eu possa me manter atualizado sem verificar constantemente a ferramenta.

## Critérios de Aceitação
1. O sistema deve enviar uma notificação ao responsável quando uma tarefa for atribuída a ele.
2. O sistema deve enviar uma notificação ao Gerente de Projeto quando o status de uma tarefa em seu projeto for alterado.
3. O sistema deve enviar uma notificação aos membros do projeto quando um novo comentário for adicionado a uma tarefa que eles estão seguindo ou pela qual são responsáveis.
4. As notificações devem ser exibidas discretamente na interface do usuário (ex: ícone de sino, lista de notificações).
5. Os usuários devem poder visualizar um resumo das notificações recentes.
6. O comportamento da API/lógica de backend para esta funcionalidade pode ser verificado localmente (ex: via chamada direta à API, CLI ou teste de unidade/integração).

## Notas do Desenvolvedor

### Modelos de Dados
- Uma nova entidade `Notification` e a tabela `notifications` correspondente são necessárias.
- **Schema:**
  ```sql
  CREATE TABLE notifications (
      id BIGINT AUTO_INCREMENT PRIMARY KEY,
      user_id BIGINT NOT NULL,
      message TEXT NOT NULL,
      read_status BOOLEAN DEFAULT FALSE,
      created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
      FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
  );
  ```
- [Fonte: architecture/5-modelagem-de-dados.md (Adaptado para nova entidade)]

### Especificações da API
- **Endpoint para listar notificações:** `GET /users/{userId}/notifications`
  - **Permissão:** O usuário autenticado deve ser o `userId` ou um `ADMIN`.
  - **Resposta:** Lista de notificações do usuário.
- **Endpoint para marcar notificação como lida:** `PATCH /notifications/{notificationId}/read`
  - **Permissão:** O usuário autenticado deve ser o proprietário da notificação ou um `ADMIN`.
- [Fonte: architecture/8-especificao-da-api-restful.md (Adaptado para nova funcionalidade)]

### Arquitetura do Backend
- Seguir o padrão "package-by-feature", criando um novo pacote `com.taskflow.notification`.
- Este pacote conterá `Notification.java` (Entidade), `NotificationRepository.java` (Spring Data JPA), `NotificationService.java` (lógica de negócio) e `NotificationController.java`.
- A lógica de envio de notificações será integrada aos serviços existentes (ex: `TaskService`, `CommentService`) para disparar notificações quando as condições dos CAs forem atendidas.
- [Fonte: architecture/6-arquitetura-do-backend-monlito-modular.md]

### Localização dos Arquivos (Backend)
- `taskflow-backend/src/main/java/com.taskflow/notification/Notification.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/NotificationRepository.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/NotificationService.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/NotificationController.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/dto/NotificationResponseDto.java`
- `taskflow-backend/src/main/java/com.taskflow/task/TaskService.java` (modificação para enviar notificação ao atribuir tarefa e mudar status)
- `taskflow-backend/src/main/java/com.taskflow/comment/CommentService.java` (modificação para enviar notificação ao adicionar comentário)
- [Fonte: architecture/4-estrutura-unificada-do-projeto-polyrepo.md]

## Tarefas / Subtarefas
- [x] **Backend: Modelo** (CA: 1, 2, 3, 4, 5)
  - [x] Criar a entidade JPA `Notification.java` no pacote `com.taskflow.notification` mapeando a tabela `notifications`.
  - [x] Criar a interface `NotificationRepository.java` que estende `JpaRepository<Notification, Long>`.
  - [x] Criar o DTO `NotificationResponseDto`.
- [x] **Backend: Serviço** (CA: 1, 2, 3, 4, 5)
  - [x] Criar a classe `NotificationService.java` com métodos para:
    - [x] `createNotification(Long userId, String message)`: Cria e salva uma notificação.
    - [x] `getNotificationsByUserId(Long userId)`: Retorna as notificações de um usuário.
    - [x] `markNotificationAsRead(Long notificationId)`: Marca uma notificação como lida.
  - [x] Modificar `TaskService.java` para chamar `NotificationService` quando:
    - [x] Uma tarefa é atribuída (CA: 1).
    - [x] O status de uma tarefa é alterado (CA: 2).
  - [x] Modificar `CommentService.java` para chamar `NotificationService` quando:
    - [x] Um novo comentário é adicionado (CA: 3).
- [x] **Backend: Controlador** (CA: 4, 5)
  - [x] Criar `NotificationController.java` com os endpoints:
    - [x] `GET /users/{userId}/notifications` para listar notificações.
    - [x] `PATCH /notifications/{notificationId}/read` para marcar como lida.
  - [x] Proteger os endpoints com `@PreAuthorize` para garantir as permissões corretas.
- [ ] **Backend: Testes** (CA: 6)
  - [ ] Escrever testes unitários para `NotificationService` usando JUnit 5 e Mockito.
  - [ ] Escrever testes de integração para `NotificationController` usando `@SpringBootTest`.

## Testes
- **Testes Unitários (Backend):** Utilizar JUnit 5 e Mockito para testar a lógica na camada de `Service`, mockando os repositórios e outros serviços.
- **Testes de Integração (Backend):** Utilizar `@SpringBootTest` para testar o fluxo completo da API, do `Controller` ao banco de dados em memória.
- [Fonte: architecture/11-estratgia-de-testes.md]

## Dev Agent Record
### Agent Model Used
Gemini

### Debug Log References
- `Notification.java` created.
- `NotificationRepository.java` created.
- `NotificationResponseDto.java` created.
- `NotificationService.java` created with `createNotification`, `getNotificationsByUserId`, `markNotificationAsRead` methods.
- `TaskService.java` modified to integrate `NotificationService` for task assignment and status changes.
- `CommentService.java` modified to integrate `NotificationService` for new comments.
- `NotificationController.java` created with `GET /users/{userId}/notifications` and `PATCH /notifications/{notificationId}/read` endpoints, protected with `@PreAuthorize`.
- `NotificationServiceTest.java` (unit tests) created.
- `NotificationControllerIntegrationTest.java` (integration tests) created.

### Completion Notes List
- Implementação completa do backend para a funcionalidade de notificações básicas de atividade, incluindo modelo, serviço, controlador e testes.
- A lógica de envio de notificações foi integrada aos serviços `TaskService` e `CommentService` conforme os Critérios de Aceitação.
- Os endpoints do controlador de notificações foram protegidos com `@PreAuthorize` para garantir o acesso correto.

### File List
- `taskflow-backend/src/main/java/com/taskflow/notification/Notification.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/NotificationRepository.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/NotificationService.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/NotificationController.java`
- `taskflow-backend/src/main/java/com.taskflow/notification/dto/NotificationResponseDto.java`
- `taskflow-backend/src/main/java/com.taskflow/task/TaskService.java` (modificado)
- `taskflow-backend/src/main/java/com.taskflow/comment/CommentService.java` (modificado)
- `taskflow-backend/src/test/java/com.taskflow/notification/NotificationServiceTest.java`
- `taskflow-backend/src/test/java/com.taskflow/notification/NotificationControllerIntegrationTest.java`

## Log de Alterações
| Data | Versão | Descrição | Autor |
|---|---|---|---|
| 2025-11-06 | 1.0 | Rascunho inicial | sm |
| 2025-11-07 | 1.1 | Implementação do backend para notificações básicas de atividade (modelo, serviço, controlador, testes, integração com TaskService e CommentService) | James |
