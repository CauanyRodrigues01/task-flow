# História 1.2: Gestão de Perfis de Usuário e Permissões Básicas

**Status:** Rascunho

**Declaração da História:** Como Administrador, quero gerenciar perfis de usuário e suas permissões, para que eu possa controlar o acesso às funcionalidades e papéis no sistema.

**Critérios de Aceitação:**
1.  O Administrador deve ter acesso a uma interface para visualizar todos os usuários registrados.
2.  O Administrador deve ser capaz de convidar novos usuários para o sistema (com perfil padrão de Colaborador).
3.  O Administrador deve ser capaz de remover usuários existentes do sistema.
4.  O Administrador deve ser capaz de alterar o perfil de um usuário entre Colaborador, Gerente de Projeto e Administrador.
5.  O sistema deve aplicar estritamente as permissões com base no perfil do usuário em todas as operações da API.
6.  O sistema deve registrar as alterações de perfil de usuário feitas pelo Administrador no histórico de atividades.
7.  O comportamento da API/lógica de backend para esta funcionalidade pode ser verificado localmente (ex: via chamada direta à API, CLI ou teste de unidade/integração).

**Notas de Desenvolvimento:**

*   **Insights da História Anterior**: A História 1.1 estabeleceu o registro e login de usuários como Colaboradores. Esta história se baseia nisso, permitindo que um Administrador gerencie esses usuários.
*   **Modelos de Dados**:
    *   **Entidade Usuário**: A tabela `users` contém `id`, `name`, `email`, `password_hash`, `role`. O campo `role` será atualizado pelo Administrador.
        *   [Fonte: architecture/5-modelagem-de-dados.md#5.2-esquema-do-banco-de-dados-mysql-ddl]
    *   **Papéis**: `ADMIN`, `PROJECT_MANAGER`, `COLLABORATOR`.
        *   [Fonte: architecture/5-modelagem-de-dados.md#5.1-modelo-conceitual-e-papéis]
*   **Especificações da API**:
    *   **URL Base**: `/api/v1`
    *   **Endpoints Implícitos para Administrador**: Serão necessários endpoints para:
        *   `GET /users`: Listar todos os usuários.
        *   `POST /users`: Convidar/criar um novo usuário (com perfil padrão).
        *   `PUT /users/{userId}/role`: Atualizar o papel de um usuário.
        *   `DELETE /users/{userId}`: Remover um usuário.
    *   **Autorização**: Endpoints protegidos com `@PreAuthorize` para garantir que apenas `ADMIN` possa realizar essas operações.
        *   [Fonte: architecture/6-arquitetura-do-backend-monlito-modular.md#6.3-autenticação-e-autorização]
*   **Especificações de Componentes (Frontend)**:
    *   `src/features/admin/UserManagementPage.tsx`: Página para listar, adicionar, editar e remover usuários.
    *   `src/features/admin/UserForm.tsx`: Componente de formulário para convidar/editar usuários.
    *   `src/services/userService.ts`: Serviço para interagir com os endpoints de gerenciamento de usuários.
    *   [Fonte: architecture/7-arquitetura-do-frontend-spa.md#7.1-organização-de-pastas]
*   **Localização de Arquivos**:
    *   **Backend (Java/Spring Boot)**:
        *   `taskflow-backend/src/main/java/com/taskflow/user/`: `UserController`, `UserService`, `UserRepository` para gerenciamento de usuários.
        *   `taskflow-backend/src/main/java/com/taskflow/security/`: Configuração de segurança para autorização baseada em papel.
        *   [Fonte: architecture.md#4-estrutura-unificada-do-projeto-polyrepo]
    *   **Frontend (React/TypeScript)**:
        *   `taskflow-frontend/src/features/admin/`: Componentes de funcionalidade de administração.
        *   `taskflow-frontend/src/services/`: Serviços de cliente de API.
        *   [Fonte: architecture.md#4-estrutura-unificada-do-projeto-polyrepo]
*   **Requisitos de Teste**:
    *   **Testes Unitários de Backend**: Testar `UserService` para lógica de gerenciamento de usuários (convidar, remover, alterar papel).
    *   **Testes de Integração de Backend**: Testar `UserController` endpoints (listar, adicionar, editar papel, remover) com diferentes papéis de usuário para verificar a autorização.
    *   **Testes de Componentes de Frontend**: Testar `UserManagementPage` e `UserForm` para renderização e interações do usuário.
*   **Restrições Técnicas**:
    *   **Autorização**: Uso de `@PreAuthorize` no backend para controle de acesso.
    *   **Validação**: Validação de entrada para dados de usuário.

**Tarefas / Subtarefas:**

1.  **Desenvolvimento de Backend (CA: 1, 2, 3, 4, 5, 6, 7)**
    *   Implementar `UserController` com endpoints para listar, convidar, atualizar papel e remover usuários.
    *   Implementar `UserService` para a lógica de negócio de gerenciamento de usuários.
    *   Adicionar anotações `@PreAuthorize("hasRole('ADMIN')")` aos métodos do `UserController` e `UserService` apropriados.
    *   **Testes Unitários**: Escrever testes unitários para `UserService` (lógica de gerenciamento de usuários).
    *   **Testes de Integração**: Escrever testes de integração para `UserController` (verificar autorização e funcionalidade dos endpoints).
2.  **Desenvolvimento de Frontend (CA: 1, 2, 3, 4, 6)**
    *   Criar `UserManagementPage` para exibir a lista de usuários e permitir ações de gerenciamento.
    *   Criar `UserForm` para convidar novos usuários e editar perfis existentes.
    *   Implementar `userService` para interagir com os novos endpoints de gerenciamento de usuários.
    *   Integrar a página de gerenciamento de usuários no roteamento do frontend, protegida para acesso apenas por Administradores.
    *   **Testes de Componentes**: Escrever testes de componentes para `UserManagementPage` e `UserForm`.

**Notas sobre a Estrutura do Projeto:**
*   A estrutura de arquivos para backend e frontend se alinha com o padrão `Polyrepo` e `package-by-feature`.